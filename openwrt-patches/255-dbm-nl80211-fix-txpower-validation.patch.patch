From 1bf69670a6b9b1064fb7af15f48346b539314001 Mon Sep 17 00:00:00 2001
From: Gilly1970 <gilroyscott@hotmail.com>
Date: Fri, 10 Oct 2025 16:31:03 +1000
Subject: [PATCH] 100-nl80211-fix-txpower-validation.patch

---
 iwinfo_nl80211.c | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/iwinfo_nl80211.c b/iwinfo_nl80211.c
index 4e8bb47..95fbba4 100644
--- a/iwinfo_nl80211.c
+++ b/iwinfo_nl80211.c
@@ -1549,7 +1549,21 @@ static int nl80211_get_txpower_cb(struct nl_msg *msg, void *arg)
 	struct nlattr **tb = nl80211_parse(msg);
 
 	if (tb[NL80211_ATTR_WIPHY_TX_POWER_LEVEL])
-		*buf = iwinfo_mbm2dbm(nla_get_u32(tb[NL80211_ATTR_WIPHY_TX_POWER_LEVEL]));
+	{
+		/*
+		 * Some drivers may report nonsensical TX power levels like
+		 * 25500 mBm to indicate an error or unknown state. Add a
+		 * sanity check to filter out physically impossible values.
+		 * A reasonable upper limit is 40 dBm.
+		 */
+		int mbm = nla_get_u32(tb[NL80211_ATTR_WIPHY_TX_POWER_LEVEL]);
+		int dbm = iwinfo_mbm2dbm(mbm);
+
+		if (dbm >= 0 && dbm <= 40)
+			*buf = dbm;
+		else
+			*buf = 0; /* Or -1 if you prefer to indicate 'unknown' */
+	}
 
 	return NL_SKIP;
 }
-- 
2.43.0

